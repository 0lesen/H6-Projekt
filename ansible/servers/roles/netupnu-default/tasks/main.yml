### Set timzone 
- name: set timezone to Europe/Copenhagen
  become: true
  timezone:
    name: Europe/Copenhagen
  notify:
    - update timezone



### create users

- name: Make sure wheel group exsists
  become: true
  group:
    name: wheel
    state: present

- name: Allow wheel users to have pswd'less sudo
  become: true
  lineinfile:
    dest: /etc/sudoers
    state: present
    regexp: '^%wheel'
    line: '%wheel ALL=(ALL) NOPASSWD: ALL'
      

- name: Add user Test bruger
  become: true
  user:
    name: test
    comment: Test bruger til netupnu
    shell: /bin/bash
    groups: wheel
    append: yes
    password: $6$LMvYHxLeeaor1PpP$dzmEMmXzZs63xNX.pRYnqGOEzqNI/6PxrHMkGpzPfFeQT14JqPHpnLL.xzN4Pa9LtUzyT2yLCVttZ4OsBZQxu1
    state: present

- name: Add Test user pub key
  become: true
  authorized_key:
    user: test
    state: present
    key: sk-ssh-ed25519@openssh.com AAAAGnNrLXNzaC1lZDI1NTE5QG9wZW5zc2guY29tAAAAIDn4WBaU0zKOXlQgoZd4VSUCxi42Sru+ad0OXtzeLvOAAAAABHNzaDo= TEST-29-11-2021-KEY2


### SNMP install

- name: Install SNMPD
  apt: pkg=snmpd state=present

- name: Download LibreNMS distro file from github to be able to determine OS with snmp 
  get_url:
    url: https://raw.githubusercontent.com/librenms/librenms-agent/master/snmp/distro
    dest: /usr/bin/distro
    mode: +x 

- name: Create /etc/snmp/snmpd.conf from template with community and location as variables
  template:                                                                     
    src: ./roles/snmp/files/snmpd.conf                            
    dest: /etc/snmp/
  notify: restart snmpd
  when: 'snmp is defined and "community" in snmp and location in snmp'


### APPLICATIONS START ###
# BIND DNS STATS
- name: Download LibreNMS BIND script file from github
  become: true
  get_url:
    url: https://github.com/librenms/librenms-agent/raw/master/snmp/bind 
    dest: /etc/snmp/bind 
    mode: +x
  when: 'apps is defined and "BIND" in apps'

- name: Add BIND extend to snmpd.conf if host is a BIND server 
  lineinfile:
    path: /etc/snmp/snmpd.conf
    line: "extend bind /etc/snmp/bind"
  when: 'apps is defined and "BIND" in apps'
  notify: restart snmpd
  become: true 

# DHCP STATS
- name: Download LibreNMS DHCP-SERVER file from github to be able to gather DHCP info with snmp 
  get_url:
    url: https://github.com/librenms/librenms-agent/raw/master/snmp/dhcp.py
    dest: /etc/snmp/dhcp.py
    mode: +x 
  notify: restart snmpd
  when: 'apps is defined and "DHCP" in apps'

- name: Create /etc/snmp/dhcp.json file
  copy:                                                                     
    src: roles/snmp/files/dhcp.json                            
    dest: /etc/snmp/dhcp.json
  notify: restart snmpd
  when: 'apps is defined and "DHCP" in apps'
