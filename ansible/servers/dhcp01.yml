---
- name: dhcp01 playbook
  hosts: dhcp01.netupnu.dk
  become: true
  roles:
    - netupnu-default
 
  vars:
    netbox_token: bbbf9087d591f7651da4b8f2ce0d13ad071927bc 
    netbox_url: https://netbox.netupnu.dk
    netbox_headers:
      Authorization: "token {{ netbox_token }}"
      Content-Type: "application/json"

  tasks:
    - name: "Get all ip addresses with a dns name" 
      become: false
      uri:
        url: "https://netbox.netupnu.dk/api/ipam/ip-addresses/?dns_name__empty=false"
        headers: "{{ netbox_headers }}"
        status_code: 200
        validate_certs: no
        force: yes
        method: GET
      register: dns_names
      delegate_to: localhost
 

  tasks:
   - name: Install isc-dhcp-server 
     apt: pkg=isc-dhcp-server state=present update_cache=yes 

   - name: Enable service isc-dhcp-server
     service:
       name: isc-dhcp-server
       enabled: yes


 
    - name: Copy bind zone configuration
      template:
        src: servers/ns01/templates/db.netupnu.dk.j2
        dest: /etc/bind/zones/db.netupnu.dk
        owner: root
        group: bind




   - name: Copy default file to server
     copy: 
      src: servers/dhcp01/files/isc-dhcp-server
      dest: /etc/default/isc-dhcp-server

   - name: Copy dhcp config file to server
     copy: 
      src: servers/dhcp01/files/dhcpd.conf
      dest: /etc/dhcp/dhcpd.conf

   - name: isc-dhcpd-server sanity check
     shell: "dhcpd -t"
     notify:
        - restart isc-dhcp-server

  handlers:
     - name: restart isc-dhcp-server
       service: name=isc-dhcp-server state=restarted
